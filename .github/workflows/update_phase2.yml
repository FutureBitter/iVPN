name: Inject VPN Logic (Phase 2)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  inject:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Inject VPN Service & Logic
        run: |
          # 1. اضافه کردن کلاس V2RayService (سرویس VPN)
          cat <<EOF > app/src/main/java/com/ivpn/app/V2RayService.kt
          package com.ivpn.app
          import android.app.Notification
          import android.app.NotificationChannel
          import android.app.NotificationManager
          import android.content.Intent
          import android.net.VpnService
          import android.os.Build
          import android.os.ParcelFileDescriptor
          import androidx.core.app.NotificationCompat
          import libv2ray.V2RayPoint
          import libv2ray.Libv2ray
          
          class V2RayService : VpnService() {
              private var mInterface: ParcelFileDescriptor? = null
              private val v2rayPoint = Libv2ray.newV2RayPoint(V2RayCallback(), Build.VERSION.SDK_INT >= Build.VERSION_CODES.N_MR1)

              override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int {
                  val action = intent?.action
                  if (action == "STOP") {
                      stopVPN()
                      return START_NOT_STICKY
                  }
                  
                  val configContent = intent?.getStringExtra("CONFIG_CONTENT") ?: ""
                  if (configContent.isNotEmpty()) {
                      startVPN(configContent)
                  }
                  return START_STICKY
              }

              private fun startVPN(config: String) {
                  // 1. نمایش نوتیفیکیشن
                  val channelId = "ivpn_service"
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                      val channel = NotificationChannel(channelId, "VPN Service", NotificationManager.IMPORTANCE_LOW)
                      getSystemService(NotificationManager::class.java).createNotificationChannel(channel)
                  }
                  val notification: Notification = NotificationCompat.Builder(this, channelId)
                      .setContentTitle("FUTURIX")
                      .setContentText("متصل به اینترنت امن")
                      .setSmallIcon(R.mipmap.ic_launcher)
                      .build()
                  startForeground(1, notification)

                  // 2. تنظیم تانل VPN
                  val builder = Builder()
                  builder.setSession("FUTURIX")
                  builder.setMtu(1500)
                  builder.addAddress("10.10.10.10", 24)
                  builder.addRoute("0.0.0.0", 0)
                  
                  try {
                      mInterface = builder.establish()
                      val fd = mInterface?.fd ?: 0
                      
                      // 3. استارت هسته V2Ray
                      // نکته: ما فعلا کانفیگ را مستقیم پاس می‌دهیم. 
                      // در نسخه کامل باید جیسون تولید شود. اینجا فقط استارت می زنیم.
                      if (!v2rayPoint.isRunning) {
                          v2rayPoint.configureFile(config)
                          v2rayPoint.runLoop(false)
                      }
                  } catch (e: Exception) {
                      e.printStackTrace()
                      stopSelf()
                  }
              }

              private fun stopVPN() {
                  try {
                      if (v2rayPoint.isRunning) {
                          v2rayPoint.stopLoop()
                      }
                      mInterface?.close()
                      mInterface = null
                      stopForeground(true)
                  } catch (e: Exception) {
                      e.printStackTrace()
                  }
                  stopSelf()
              }
              
              override fun onDestroy() {
                  stopVPN()
                  super.onDestroy()
              }
              
              // کلاس کالبک برای دریافت وضعیت از هسته
              class V2RayCallback : libv2ray.V2RayVPNServiceSupportsSet {
                  override fun onEmitStatus(j: Long, s: String?): Long { return 0 }
                  override fun prepare(): Long { return 0 }
                  override fun protect(l: Long): Long { return 0 }
                  override fun setup(s: String?): Long { return 0 }
                  override fun shutdown(): Long { return 0 }
              }
          }
          EOF

          # 2. آپدیت MainActivity برای استارت سرویس
          cat <<EOF > app/src/main/java/com/ivpn/app/MainActivity.kt
          package com.ivpn.app
          import android.content.Intent
          import android.graphics.Color
          import android.net.VpnService
          import android.os.Bundle
          import android.widget.Button
          import android.widget.TextView
          import android.widget.Toast
          import androidx.appcompat.app.AppCompatActivity
          import okhttp3.*
          import java.io.IOException

          class MainActivity : AppCompatActivity() {
              private var isConnected = false
              
              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  setContentView(R.layout.activity_main)
                  
                  val prefs = getSharedPreferences("ivpn_data", MODE_PRIVATE)
                  val subLink = prefs.getString("sub_link", "")
                  
                  val btnConnect = findViewById<Button>(R.id.btnConnect)
                  val tvStatus = findViewById<TextView>(R.id.tvStatus)
                  val btnLogout = findViewById<Button>(R.id.btnLogout)

                  btnConnect.setOnClickListener {
                      if (!isConnected) {
                          // درخواست مجوز VPN از اندروید
                          val intent = VpnService.prepare(this)
                          if (intent != null) {
                              startActivityForResult(intent, 1)
                          } else {
                              startVpnService(subLink ?: "")
                              updateUI(true, btnConnect, tvStatus)
                          }
                      } else {
                          // قطع اتصال
                          val intent = Intent(this, V2RayService::class.java)
                          intent.action = "STOP"
                          startService(intent)
                          updateUI(false, btnConnect, tvStatus)
                      }
                  }
                  
                  btnLogout.setOnClickListener {
                      prefs.edit().clear().apply()
                      startActivity(Intent(this, LoginActivity::class.java))
                      finish()
                  }
              }

              override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
                  super.onActivityResult(requestCode, resultCode, data)
                  if (requestCode == 1 && resultCode == RESULT_OK) {
                      val prefs = getSharedPreferences("ivpn_data", MODE_PRIVATE)
                      val subLink = prefs.getString("sub_link", "")
                      startVpnService(subLink ?: "")
                      val btnConnect = findViewById<Button>(R.id.btnConnect)
                      val tvStatus = findViewById<TextView>(R.id.tvStatus)
                      updateUI(true, btnConnect, tvStatus)
                  }
              }

              private fun startVpnService(link: String) {
                  Toast.makeText(this, "در حال دریافت کانفیگ...", Toast.LENGTH_SHORT).show()
                  // دانلود محتوای لینک سابسکریپشن
                  val client = OkHttpClient()
                  val request = Request.Builder().url(link).build()
                  
                  client.newCall(request).enqueue(object : Callback {
                      override fun onFailure(call: Call, e: IOException) {
                          runOnUiThread { Toast.makeText(applicationContext, "خطا در دانلود کانفیگ", Toast.LENGTH_SHORT).show() }
                      }
                      override fun onResponse(call: Call, response: Response) {
                          val configBody = response.body?.string()
                          if (configBody != null) {
                              // استارت سرویس با کانفیگ دانلود شده
                              val intent = Intent(applicationContext, V2RayService::class.java)
                              // نکته: اینجا باید کانفیگ خام را به فرمت جیسون V2Ray تبدیل کنیم
                              // فعلا متن خام را میفرستیم (نیاز به پارسر دارد در آینده)
                              intent.putExtra("CONFIG_CONTENT", configBody) 
                              startForegroundService(intent)
                              runOnUiThread { 
                                  Toast.makeText(applicationContext, "سرویس استارت شد", Toast.LENGTH_SHORT).show() 
                              }
                          }
                      }
                  })
              }

              private fun updateUI(connected: Boolean, btn: Button, txt: TextView) {
                  isConnected = connected
                  if (connected) {
                      txt.text = "متصل شد"
                      txt.setTextColor(Color.parseColor("#10B981"))
                      btn.setBackgroundColor(Color.parseColor("#374151"))
                      btn.text = "قطع اتصال"
                  } else {
                      txt.text = "قطع شده"
                      txt.setTextColor(Color.parseColor("#94A3B8"))
                      btn.setBackgroundColor(Color.parseColor("#1E293B"))
                      btn.text = "اتصال"
                  }
              }
          }
          EOF

          # 3. آپدیت AndroidManifest برای ثبت سرویس
          # ما فایل را کامل بازنویسی میکنیم تا سرویس اضافه شود
          cat <<EOF > app/src/main/AndroidManifest.xml
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              xmlns:tools="http://schemas.android.com/tools">
              <uses-permission android:name="android.permission.INTERNET" />
              <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE_SPECIAL_USE" />

              <application
                  android:allowBackup="true"
                  android:icon="@mipmap/ic_launcher"
                  android:label="iVPN"
                  android:roundIcon="@mipmap/ic_launcher_round"
                  android:supportsRtl="true"
                  android:theme="@style/Theme.iVPN"
                  tools:targetApi="31">
                  <activity
                      android:name=".LoginActivity"
                      android:exported="true"
                      android:theme="@style/Theme.iVPN"
                      android:screenOrientation="portrait">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
                  <activity
                      android:name=".MainActivity"
                      android:exported="false"
                      android:screenOrientation="portrait"/>
                  
                  <!-- سرویس VPN اضافه شد -->
                  <service
                      android:name=".V2RayService"
                      android:exported="false"
                      android:permission="android.permission.BIND_VPN_SERVICE">
                      <intent-filter>
                          <action android:name="android.net.VpnService" />
                      </intent-filter>
                  </service>
              </application>
          </manifest>
          EOF

      - name: Commit Changes
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add .
          git commit -m "Injected VPN Service Logic"
          git push
