name: Inject Pro Features (List, Ping, Usage)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  inject_pro:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create UI Layouts
        run: |
          # ساخت پوشه‌های ضروری (رفع ارور No such file)
          mkdir -p app/src/main/res/drawable
          mkdir -p app/src/main/res/layout
          
          # 1. طراحی جدید صفحه اصلی (لیست + نوار حجم)
          cat <<EOF > app/src/main/res/layout/activity_main.xml
          <?xml version="1.0" encoding="utf-8"?>
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              xmlns:app="http://schemas.android.com/apk/res-auto"
              android:layout_width="match_parent"
              android:layout_height="match_parent"
              android:orientation="vertical"
              android:background="#0F172A"
              android:padding="16dp">

              <!-- هدر و خروج -->
              <RelativeLayout
                  android:layout_width="match_parent"
                  android:layout_height="wrap_content"
                  android:layout_marginBottom="16dp">
                  <TextView
                      android:id="@+id/tvTitle"
                      android:layout_width="wrap_content"
                      android:layout_height="wrap_content"
                      android:text="iVPN"
                      android:textColor="#FFFFFF"
                      android:textSize="20sp"
                      android:textStyle="bold"/>
                  <ImageView
                      android:id="@+id/btnLogout"
                      android:layout_width="24dp"
                      android:layout_height="24dp"
                      android:src="@android:drawable/ic_lock_power_off"
                      app:tint="#EF4444"
                      android:layout_alignParentEnd="true"/>
              </RelativeLayout>

              <!-- کارت وضعیت حجم -->
              <androidx.cardview.widget.CardView
                  android:layout_width="match_parent"
                  android:layout_height="wrap_content"
                  app:cardBackgroundColor="#1E293B"
                  app:cardCornerRadius="12dp"
                  android:layout_marginBottom="16dp">
                  <LinearLayout
                      android:layout_width="match_parent"
                      android:layout_height="wrap_content"
                      android:orientation="vertical"
                      android:padding="16dp">
                      <TextView
                          android:text="وضعیت بسته"
                          android:textColor="#94A3B8"
                          android:textSize="12sp"/>
                      <LinearLayout
                          android:layout_width="match_parent"
                          android:layout_height="wrap_content"
                          android:orientation="horizontal"
                          android:layout_marginTop="8dp"
                          android:weightSum="2">
                          <TextView
                              android:id="@+id/tvUsed"
                              android:layout_width="0dp"
                              android:layout_height="wrap_content"
                              android:layout_weight="1"
                              android:text="مصرف: ..."
                              android:textColor="#FFFFFF"
                              android:textSize="14sp"/>
                          <TextView
                              android:id="@+id/tvTotal"
                              android:layout_width="0dp"
                              android:layout_height="wrap_content"
                              android:layout_weight="1"
                              android:gravity="end"
                              android:text="کل: ..."
                              android:textColor="#FFFFFF"
                              android:textSize="14sp"/>
                      </LinearLayout>
                      <ProgressBar
                          android:id="@+id/progressTraffic"
                          style="?android:attr/progressBarStyleHorizontal"
                          android:layout_width="match_parent"
                          android:layout_height="8dp"
                          android:layout_marginTop="8dp"
                          android:progressDrawable="@drawable/custom_progress"
                          android:progress="50"/>
                      <TextView
                          android:id="@+id/tvExpire"
                          android:layout_width="match_parent"
                          android:layout_height="wrap_content"
                          android:text="انقضا: ..."
                          android:textColor="#F59E0B"
                          android:textSize="12sp"
                          android:layout_marginTop="8dp"
                          android:gravity="end"/>
                  </LinearLayout>
              </androidx.cardview.widget.CardView>

              <TextView
                  android:text="انتخاب سرور (بهترین پینگ)"
                  android:textColor="#94A3B8"
                  android:textSize="12sp"
                  android:layout_marginBottom="8dp"/>

              <!-- لیست کانفیگ‌ها -->
              <androidx.recyclerview.widget.RecyclerView
                  android:id="@+id/recyclerConfigs"
                  android:layout_width="match_parent"
                  android:layout_height="0dp"
                  android:layout_weight="1"/>

              <!-- دکمه اتصال شناور -->
              <Button
                  android:id="@+id/btnConnectMain"
                  android:layout_width="match_parent"
                  android:layout_height="60dp"
                  android:text="اتصال هوشمند"
                  android:backgroundTint="#4F46E5"
                  android:layout_marginTop="10dp"
                  android:textSize="18sp"
                  android:textStyle="bold"/>
          </LinearLayout>
          EOF

          # 2. استایل نوار پیشرفت (Custom Progress)
          cat <<EOF > app/src/main/res/drawable/custom_progress.xml
          <?xml version="1.0" encoding="utf-8"?>
          <layer-list xmlns:android="http://schemas.android.com/apk/res/android">
              <item android:id="@android:id/background">
                  <shape>
                      <corners android:radius="5dp"/>
                      <solid android:color="#334155"/>
                  </shape>
              </item>
              <item android:id="@android:id/progress">
                  <clip>
                      <shape>
                          <corners android:radius="5dp"/>
                          <solid android:color="#10B981"/>
                      </shape>
                  </clip>
              </item>
          </layer-list>
          EOF

          # 3. لی‌اوت آیتم لیست (item_config.xml)
          cat <<EOF > app/src/main/res/layout/item_config.xml
          <?xml version="1.0" encoding="utf-8"?>
          <androidx.cardview.widget.CardView xmlns:android="http://schemas.android.com/apk/res/android"
              xmlns:app="http://schemas.android.com/apk/res-auto"
              android:layout_width="match_parent"
              android:layout_height="wrap_content"
              android:layout_marginBottom="8dp"
              app:cardBackgroundColor="#1E293B"
              app:cardCornerRadius="8dp"
              android:foreground="?android:attr/selectableItemBackground">
              <LinearLayout
                  android:layout_width="match_parent"
                  android:layout_height="wrap_content"
                  android:orientation="horizontal"
                  android:padding="16dp"
                  android:gravity="center_vertical">
                  <ImageView
                      android:id="@+id/imgSelect"
                      android:layout_width="24dp"
                      android:layout_height="24dp"
                      android:src="@android:drawable/radiobutton_off_background"
                      app:tint="#64748B"/>
                  <LinearLayout
                      android:layout_width="0dp"
                      android:layout_height="wrap_content"
                      android:layout_weight="1"
                      android:orientation="vertical"
                      android:layout_marginStart="12dp">
                      <TextView
                          android:id="@+id/tvConfigName"
                          android:layout_width="wrap_content"
                          android:layout_height="wrap_content"
                          android:text="Server Name"
                          android:textColor="#FFFFFF"
                          android:textStyle="bold"/>
                      <TextView
                          android:id="@+id/tvConfigType"
                          android:layout_width="wrap_content"
                          android:layout_height="wrap_content"
                          android:text="VLESS"
                          android:textColor="#64748B"
                          android:textSize="10sp"/>
                  </LinearLayout>
                  <TextView
                      android:id="@+id/tvPing"
                      android:layout_width="wrap_content"
                      android:layout_height="wrap_content"
                      android:text="- ms"
                      android:textColor="#F59E0B"
                      android:textStyle="bold"/>
              </LinearLayout>
          </androidx.cardview.widget.CardView>
          EOF

      - name: Create Logic Classes
        run: |
          # 4. ابزار پارس کانفیگ (V2RayConfigUtil.kt)
          mkdir -p app/src/main/java/com/ivpn/app/util
          cat <<EOF > app/src/main/java/com/ivpn/app/util/V2RayConfigUtil.kt
          package com.ivpn.app.util
          
          import android.util.Base64
          import org.json.JSONObject
          import java.net.URI
          import java.net.URLDecoder
          import java.nio.charset.StandardCharsets
          
          object V2RayConfigUtil {
              data class ConfigItem(val name: String, val uri: String, var ping: Long = -1, var isSelected: Boolean = false)

              fun parseSubscription(content: String): List<ConfigItem> {
                  val list = mutableListOf<ConfigItem>()
                  try {
                      // Decode Base64 if needed
                      val decoded = try {
                          String(Base64.decode(content, Base64.DEFAULT), StandardCharsets.UTF_8)
                      } catch (e: Exception) { content }
                      
                      decoded.lines().forEach { line ->
                          val trimmed = line.trim()
                          if (trimmed.startsWith("vless://")) {
                              try {
                                  val name = URLDecoder.decode(trimmed.substringAfter("#"), "UTF-8")
                                  list.add(ConfigItem(name, trimmed))
                              } catch(e: Exception) {
                                  list.add(ConfigItem("Server", trimmed))
                              }
                          }
                      }
                  } catch (e: Exception) { e.printStackTrace() }
                  return list
              }

              // تبدیل VLESS به JSON برای هسته
              fun generateV2RayJson(uriString: String): String {
                  try {
                      val uri = URI(uriString) // vless://uuid@ip:port?query#name
                      val userInfo = uri.userInfo
                      val host = uri.host
                      val port = uri.port
                      val query = uri.query ?: ""
                      
                      val json = JSONObject()
                      val log = JSONObject().put("loglevel", "warning")
                      json.put("log", log)
                      
                      val inbounds = org.json.JSONArray()
                      val inbound = JSONObject()
                      inbound.put("port", 10808)
                      inbound.put("listen", "127.0.0.1")
                      inbound.put("protocol", "socks")
                      inbound.put("tag", "socks")
                      inbound.put("settings", JSONObject().put("udp", true))
                      inbounds.put(inbound)
                      json.put("inbounds", inbounds)
                      
                      val outbounds = org.json.JSONArray()
                      val outbound = JSONObject()
                      outbound.put("tag", "proxy")
                      outbound.put("protocol", "vless")
                      
                      val vnext = org.json.JSONArray()
                      val server = JSONObject()
                      server.put("address", host)
                      server.put("port", port)
                      val users = org.json.JSONArray()
                      val user = JSONObject()
                      user.put("id", userInfo)
                      user.put("encryption", "none")
                      users.put(user)
                      server.put("users", users)
                      vnext.put(server)
                      
                      val settings = JSONObject()
                      settings.put("vnext", vnext)
                      outbound.put("settings", settings)
                      
                      val stream = JSONObject()
                      stream.put("network", "tcp")
                      if (query.contains("type=ws")) {
                          stream.put("network", "ws")
                          stream.put("wsSettings", JSONObject().put("path", "/").put("headers", JSONObject()))
                      }
                      if (query.contains("security=tls")) {
                          stream.put("security", "tls")
                      }
                      outbound.put("streamSettings", stream)
                      
                      outbounds.put(outbound)
                      json.put("outbounds", outbounds)
                      
                      return json.toString()
                  } catch (e: Exception) {
                      return ""
                  }
              }
          }
          EOF

          # 5. کد Adapter برای لیست (ConfigAdapter.kt)
          cat <<EOF > app/src/main/java/com/ivpn/app/ConfigAdapter.kt
          package com.ivpn.app
          
          import android.graphics.Color
          import android.view.LayoutInflater
          import android.view.View
          import android.view.ViewGroup
          import android.widget.ImageView
          import android.widget.TextView
          import androidx.recyclerview.widget.RecyclerView
          import com.ivpn.app.util.V2RayConfigUtil.ConfigItem
          import com.ivpn.app.R

          class ConfigAdapter(
              private var items: List<ConfigItem>,
              private val onSelect: (ConfigItem) -> Unit
          ) : RecyclerView.Adapter<ConfigAdapter.VH>() {

              class VH(v: View) : RecyclerView.ViewHolder(v) {
                  val name: TextView = v.findViewById(R.id.tvConfigName)
                  val type: TextView = v.findViewById(R.id.tvConfigType)
                  val ping: TextView = v.findViewById(R.id.tvPing)
                  val icon: ImageView = v.findViewById(R.id.imgSelect)
                  val card: View = v
              }

              override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): VH {
                  val v = LayoutInflater.from(parent.context).inflate(R.layout.item_config, parent, false)
                  return VH(v)
              }

              override fun onBindViewHolder(holder: VH, position: Int) {
                  val item = items[position]
                  holder.name.text = item.name.ifEmpty { "Server \${position + 1}" }
                  
                  if (item.ping > 0) {
                      holder.ping.text = "\${item.ping} ms"
                      holder.ping.setTextColor(if (item.ping < 500) Color.GREEN else Color.YELLOW)
                  } else {
                      holder.ping.text = "Testing..."
                      holder.ping.setTextColor(Color.GRAY)
                  }

                  if (item.isSelected) {
                      holder.icon.setImageResource(android.R.drawable.radiobutton_on_background)
                      holder.icon.setColorFilter(Color.parseColor("#4F46E5"))
                  } else {
                      holder.icon.setImageResource(android.R.drawable.radiobutton_off_background)
                      holder.icon.setColorFilter(Color.GRAY)
                  }

                  holder.card.setOnClickListener { onSelect(item) }
              }

              override fun getItemCount() = items.size
              
              fun updateList(newItems: List<ConfigItem>) {
                  items = newItems
                  notifyDataSetChanged()
              }
          }
          EOF

          # 6. آپدیت MainActivity.kt (منطق اصلی)
          cat <<EOF > app/src/main/java/com/ivpn/app/MainActivity.kt
          package com.ivpn.app

          import android.content.Intent
          import android.graphics.Color
          import android.net.VpnService
          import android.os.Bundle
          import android.widget.Button
          import android.widget.ImageView
          import android.widget.ProgressBar
          import android.widget.TextView
          import android.widget.Toast
          import androidx.appcompat.app.AppCompatActivity
          import androidx.recyclerview.widget.LinearLayoutManager
          import androidx.recyclerview.widget.RecyclerView
          import com.ivpn.app.util.V2RayConfigUtil
          import com.ivpn.app.util.V2RayConfigUtil.ConfigItem
          import okhttp3.*
          import java.io.IOException
          import java.net.InetSocketAddress
          import java.net.Socket
          import java.net.URI
          import kotlin.concurrent.thread
          import com.google.gson.Gson
          import org.json.JSONObject

          class MainActivity : AppCompatActivity() {
              private var isConnected = false
              private lateinit var adapter: ConfigAdapter
              private var configList = mutableListOf<ConfigItem>()
              private var selectedConfig: ConfigItem? = null
              
              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  setContentView(R.layout.activity_main)
                  
                  val prefs = getSharedPreferences("ivpn_data", MODE_PRIVATE)
                  val username = prefs.getString("username", "") ?: ""
                  
                  // Setup UI
                  val btnLogout = findViewById<ImageView>(R.id.btnLogout)
                  val tvUsed = findViewById<TextView>(R.id.tvUsed)
                  val tvTotal = findViewById<TextView>(R.id.tvTotal)
                  val tvExpire = findViewById<TextView>(R.id.tvExpire)
                  val progress = findViewById<ProgressBar>(R.id.progressTraffic)
                  val recycler = findViewById<RecyclerView>(R.id.recyclerConfigs)
                  val btnConnect = findViewById<Button>(R.id.btnConnectMain)

                  recycler.layoutManager = LinearLayoutManager(this)
                  adapter = ConfigAdapter(configList) { item ->
                      selectConfig(item)
                  }
                  recycler.adapter = adapter

                  btnLogout.setOnClickListener {
                      prefs.edit().clear().apply()
                      startActivity(Intent(this, LoginActivity::class.java))
                      finish()
                  }

                  btnConnect.setOnClickListener {
                      if (!isConnected) {
                          if (selectedConfig == null) {
                              Toast.makeText(this, "لطفا یک سرور انتخاب کنید", Toast.LENGTH_SHORT).show()
                              return@setOnClickListener
                          }
                          val intent = VpnService.prepare(this)
                          if (intent != null) {
                              startActivityForResult(intent, 1)
                          } else {
                              startVpn()
                          }
                      } else {
                          stopVpn()
                      }
                  }

                  // 1. لاگین مجدد برای دریافت حجم و لینک
                  refreshUserData(username, prefs.getString("sub_link", "") ?: "")
              }

              override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
                  super.onActivityResult(requestCode, resultCode, data)
                  if (requestCode == 1 && resultCode == RESULT_OK) {
                      startVpn()
                  }
              }

              private fun refreshUserData(username: String, fallbackLink: String) {
                  val client = OkHttpClient()
                  
                  // الف) دریافت کانفیگ‌ها از لینک سابسکریپشن
                  if (fallbackLink.isNotEmpty()) {
                      val request = Request.Builder().url(fallbackLink).build()
                      client.newCall(request).enqueue(object : Callback {
                          override fun onFailure(call: Call, e: IOException) { }
                          override fun onResponse(call: Call, response: Response) {
                              val body = response.body?.string()
                              if (body != null) {
                                  val parsed = V2RayConfigUtil.parseSubscription(body)
                                  runOnUiThread {
                                      configList.clear()
                                      configList.addAll(parsed)
                                      adapter.updateList(configList)
                                      testPings() // شروع تست پینگ
                                  }
                              }
                          }
                      })
                  }
                  
                  // ب) دریافت حجم از API لاگین (آپدیت مخفی)
                  // اینجا چون رمز را نداریم، فعلا فقط از کش استفاده میکنیم یا کاربر باید لاگین مجدد کند
                  // در نسخه پیشرفته باید توکن ذخیره کنیم. فعلا این بخش را ساده میگیریم.
              }

              private fun selectConfig(item: ConfigItem) {
                  configList.forEach { it.isSelected = false }
                  item.isSelected = true
                  selectedConfig = item
                  adapter.updateList(configList)
              }

              private fun testPings() {
                  thread {
                      configList.forEachIndexed { index, item ->
                          try {
                              val uri = URI(item.uri)
                              val start = System.currentTimeMillis()
                              val socket = Socket()
                              socket.connect(InetSocketAddress(uri.host, uri.port), 2000) 
                              socket.close()
                              item.ping = System.currentTimeMillis() - start
                          } catch (e: Exception) {
                              item.ping = -1 
                          }
                          runOnUiThread { adapter.notifyItemChanged(index) }
                      }
                      // سورت کردن: اول پینگ‌دارها، بعد بقیه
                      configList.sortBy { if (it.ping > 0) it.ping else 9999 }
                      runOnUiThread { 
                          adapter.updateList(configList)
                          if (configList.isNotEmpty() && selectedConfig == null) {
                              selectConfig(configList[0]) // انتخاب بهترین به صورت خودکار
                          }
                      }
                  }
              }

              private fun startVpn() {
                  selectedConfig?.let { config ->
                      // تبدیل لینک VLESS به JSON استاندارد Xray
                      val jsonConfig = V2RayConfigUtil.generateV2RayJson(config.uri)
                      
                      if (jsonConfig.isNotEmpty()) {
                          val intent = Intent(this, V2RayService::class.java)
                          intent.putExtra("CONFIG_CONTENT", jsonConfig)
                          startForegroundService(intent)
                          isConnected = true
                          findViewById<Button>(R.id.btnConnectMain).text = "قطع اتصال"
                          findViewById<Button>(R.id.btnConnectMain).setBackgroundColor(Color.parseColor("#374151"))
                      } else {
                          Toast.makeText(this, "فرمت کانفیگ پشتیبانی نمی‌شود", Toast.LENGTH_SHORT).show()
                      }
                  }
              }

              private fun stopVpn() {
                  val intent = Intent(this, V2RayService::class.java)
                  intent.action = "STOP"
                  startService(intent)
                  isConnected = false
                  findViewById<Button>(R.id.btnConnectMain).text = "اتصال هوشمند"
                  findViewById<Button>(R.id.btnConnectMain).setBackgroundColor(Color.parseColor("#4F46E5"))
              }
          }
          EOF

      - name: Commit Changes
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add .
          git commit -m "Inject Pro Features (Fixed Directory)"
          git push
