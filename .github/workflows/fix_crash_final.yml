name: Rescue App (Re-create UI & Fix Crash)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  rescue_app:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Re-create All Layouts & Drawables
        run: |
          # 1. ساخت پوشه‌های ضروری
          mkdir -p app/src/main/res/drawable
          mkdir -p app/src/main/res/layout
          mkdir -p app/src/main/res/values
          mkdir -p app/src/main/java/com/ivpn/app/util

          # 2. ساخت فایل گرافیکی نوار پیشرفت (که احتمالا باعث کرش بود)
          cat <<EOF > app/src/main/res/drawable/custom_progress.xml
          <?xml version="1.0" encoding="utf-8"?>
          <layer-list xmlns:android="http://schemas.android.com/apk/res/android">
              <item android:id="@android:id/background">
                  <shape>
                      <corners android:radius="5dp"/>
                      <solid android:color="#334155"/>
                  </shape>
              </item>
              <item android:id="@android:id/progress">
                  <clip>
                      <shape>
                          <corners android:radius="5dp"/>
                          <solid android:color="#10B981"/>
                      </shape>
                  </clip>
              </item>
          </layer-list>
          EOF

          # 3. بازنویسی صفحه اصلی (ساده و امن)
          cat <<EOF > app/src/main/res/layout/activity_main.xml
          <?xml version="1.0" encoding="utf-8"?>
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              xmlns:app="http://schemas.android.com/apk/res-auto"
              android:layout_width="match_parent"
              android:layout_height="match_parent"
              android:orientation="vertical"
              android:background="#0F172A"
              android:padding="16dp">

              <RelativeLayout
                  android:layout_width="match_parent"
                  android:layout_height="wrap_content"
                  android:layout_marginBottom="16dp">
                  <TextView
                      android:id="@+id/tvTitle"
                      android:layout_width="wrap_content"
                      android:layout_height="wrap_content"
                      android:text="iVPN"
                      android:textColor="#FFFFFF"
                      android:textSize="20sp"
                      android:textStyle="bold"/>
                  <ImageView
                      android:id="@+id/btnLogout"
                      android:layout_width="24dp"
                      android:layout_height="24dp"
                      android:src="@android:drawable/ic_lock_power_off"
                      app:tint="#EF4444"
                      android:layout_alignParentEnd="true"/>
              </RelativeLayout>

              <androidx.cardview.widget.CardView
                  android:layout_width="match_parent"
                  android:layout_height="wrap_content"
                  app:cardBackgroundColor="#1E293B"
                  app:cardCornerRadius="12dp"
                  android:layout_marginBottom="16dp">
                  <LinearLayout
                      android:layout_width="match_parent"
                      android:layout_height="wrap_content"
                      android:orientation="vertical"
                      android:padding="16dp">
                      <TextView
                          android:text="وضعیت بسته"
                          android:textColor="#94A3B8"
                          android:textSize="12sp"/>
                      <LinearLayout
                          android:layout_width="match_parent"
                          android:layout_height="wrap_content"
                          android:orientation="horizontal"
                          android:layout_marginTop="8dp"
                          android:weightSum="2">
                          <TextView
                              android:id="@+id/tvUsed"
                              android:layout_width="0dp"
                              android:layout_height="wrap_content"
                              android:layout_weight="1"
                              android:text="مصرف: ..."
                              android:textColor="#FFFFFF"
                              android:textSize="14sp"/>
                          <TextView
                              android:id="@+id/tvTotal"
                              android:layout_width="0dp"
                              android:layout_height="wrap_content"
                              android:layout_weight="1"
                              android:gravity="end"
                              android:text="کل: ..."
                              android:textColor="#FFFFFF"
                              android:textSize="14sp"/>
                      </LinearLayout>
                      <ProgressBar
                          android:id="@+id/progressTraffic"
                          style="?android:attr/progressBarStyleHorizontal"
                          android:layout_width="match_parent"
                          android:layout_height="8dp"
                          android:layout_marginTop="8dp"
                          android:progressDrawable="@drawable/custom_progress"
                          android:progress="50"/>
                      <TextView
                          android:id="@+id/tvExpire"
                          android:layout_width="match_parent"
                          android:layout_height="wrap_content"
                          android:text="انقضا: ..."
                          android:textColor="#F59E0B"
                          android:textSize="12sp"
                          android:layout_marginTop="8dp"
                          android:gravity="end"/>
                  </LinearLayout>
              </androidx.cardview.widget.CardView>

              <TextView
                  android:text="سرورها"
                  android:textColor="#94A3B8"
                  android:textSize="12sp"
                  android:layout_marginBottom="8dp"/>

              <androidx.recyclerview.widget.RecyclerView
                  android:id="@+id/recyclerConfigs"
                  android:layout_width="match_parent"
                  android:layout_height="0dp"
                  android:layout_weight="1"/>

              <Button
                  android:id="@+id/btnConnectMain"
                  android:layout_width="match_parent"
                  android:layout_height="60dp"
                  android:text="اتصال هوشمند"
                  android:backgroundTint="#4F46E5"
                  android:layout_marginTop="10dp"
                  android:textSize="18sp"
                  android:textStyle="bold"/>
          </LinearLayout>
          EOF

          # 4. بازنویسی صفحه لاگین (استاندارد و بدون باگ)
          cat <<EOF > app/src/main/res/layout/activity_login.xml
          <?xml version="1.0" encoding="utf-8"?>
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent"
              android:layout_height="match_parent"
              android:orientation="vertical"
              android:gravity="center"
              android:padding="30dp"
              android:background="#0F172A">
              <TextView
                  android:layout_width="wrap_content"
                  android:layout_height="wrap_content"
                  android:text="iVPN"
                  android:textSize="32sp"
                  android:textStyle="bold"
                  android:textColor="#4F46E5"
                  android:layout_marginBottom="40dp"/>
              <EditText
                  android:id="@+id/etUsername"
                  android:layout_width="match_parent"
                  android:layout_height="50dp"
                  android:hint="نام کاربری"
                  android:textColor="#FFFFFF"
                  android:textColorHint="#94A3B8"
                  android:background="#1E293B"
                  android:padding="10dp"
                  android:layout_marginBottom="15dp"/>
              <EditText
                  android:id="@+id/etPassword"
                  android:layout_width="match_parent"
                  android:layout_height="50dp"
                  android:hint="رمز عبور"
                  android:inputType="textPassword"
                  android:textColor="#FFFFFF"
                  android:textColorHint="#94A3B8"
                  android:background="#1E293B"
                  android:padding="10dp"
                  android:layout_marginBottom="25dp"/>
              <Button
                  android:id="@+id/btnLogin"
                  android:layout_width="match_parent"
                  android:layout_height="55dp"
                  android:text="ورود"
                  android:backgroundTint="#4F46E5"
                  android:textColor="#FFFFFF"/>
              <ProgressBar
                  android:id="@+id/progressBar"
                  android:layout_width="wrap_content"
                  android:layout_height="wrap_content"
                  android:layout_marginTop="20dp"
                  android:visibility="gone"/>
          </LinearLayout>
          EOF

          # 5. بازنویسی تنظیمات گریدل (با فعال‌سازی MultiDex و وابستگی‌ها)
          cat <<EOF > app/build.gradle.kts
          plugins {
              id("com.android.application")
              id("org.jetbrains.kotlin.android")
          }

          android {
              namespace = "com.ivpn.app"
              compileSdk = 34

              defaultConfig {
                  applicationId = "com.ivpn.app"
                  minSdk = 24
                  targetSdk = 34
                  versionCode = 1
                  versionName = "1.0.0"
                  multiDexEnabled = true // رفع کرش ناشی از تعداد متدها
              }

              buildTypes {
                  release {
                      isMinifyEnabled = false
                      proguardFiles(getDefaultProguardFile("proguard-android-optimize.txt"), "proguard-rules.pro")
                  }
              }
              compileOptions {
                  sourceCompatibility = JavaVersion.VERSION_1_8
                  targetCompatibility = JavaVersion.VERSION_1_8
              }
              kotlinOptions {
                  jvmTarget = "1.8"
              }
              buildFeatures {
                  viewBinding = true
              }
          }

          dependencies {
              implementation("androidx.core:core-ktx:1.12.0")
              implementation("androidx.appcompat:appcompat:1.6.1")
              implementation("com.google.android.material:material:1.11.0")
              implementation("androidx.constraintlayout:constraintlayout:2.1.4")
              implementation("com.squareup.okhttp3:okhttp:4.12.0")
              implementation("com.google.code.gson:gson:2.10.1")
              implementation("androidx.recyclerview:recyclerview:1.3.2")
              implementation("androidx.cardview:cardview:1.0.0")
              implementation("androidx.multidex:multidex:2.0.1")
              
              // هسته وی‌پی‌ان
              implementation(fileTree(mapOf("dir" to "libs", "include" to listOf("*.aar", "*.jar"))))
          }
          EOF

      - name: Commit Fixes
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add .
          git commit -m "Rescue: Re-created all UI resources and dependencies"
          git push
